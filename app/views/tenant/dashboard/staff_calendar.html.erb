<% content_title "Staff Leave Calendar" %>

<div style="margin-bottom: 14px; z-order: 0;">

  <%= form_for @staff_calendar, :url => '' do |f| %>

    <%= error_messages_for @staff_calendar %>

    <table width="100%">
      <tr>
        <td width="120px">From:</td>
        <td width="30px"></td>
        <td class="field"><%= f.date_picker :date_from %></td>
      </tr>
      <tr>
        <td>To:</td>
        <td></td>
        <td class="field"><%= f.date_picker :date_to %></td>
      </tr>
      <tr>
        <td>Location:</td>
        <td><%= f.radio_button :filter_by, 'location' %></td>
        <td class="field">
          <%= f.select :item_id, current_account.locations.collect {|item| [item.title, item.to_param]}, { :include_blank => true }, { :class => 'dropdown' } %>
        </td>
      </tr>
      <tr>
        <td>Department:</td>
        <td><%= f.radio_button :filter_by, 'department' %></td>
        <td class="field">
          <%= f.select :item_id, current_account.departments.collect {|item| [item.title, item.to_param]}, { :include_blank => true }, { :class => 'dropdown' } %>
        </td>
      </tr>
      <tr>
        <td>Employee:</td>
        <td><%= f.radio_button :filter_by, 'employee' %></td>
        <td class="field">
          <%= f.select :item_id, current_employee.staff.collect {|item| [item.full_name, item.to_param]}, { :include_blank => true }, { :class => 'dropdown' } %>
        </td>
      </tr>
      <tr>
        <td colspan="3" align="right">
          <%= f.submit 'Update Displayed Data' %>
        </td>
      </tr>
    </table>
    
  <% end %>
  
</div>

<div id="slider"></div>

<div style="height: 20px;"></div>

<div id="staff_calendar">

  <!-- staff and leave requests -->
  <div style="width: 120px; float: left;">
    <table id="staff" width="100%">
      <thead>
        <tr><td></td></tr>
        <tr><td></td></tr>
        <tr><td style="text-align: center;"><strong>Employee</strong></td></tr>
      </thead>
      <tbody>
      <% @staff_calendar.employees.each do |employee| %>
        <tr><td><strong><%= employee.full_name %></strong></td></tr>
        
        <% @staff_calendar.leave_requests_for(employee).each do |leave_request| %>
          <tr><td class="indent"><%= link_to leave_request.leave_type.to_s, edit_leave_request_path(leave_request, :tenant => current_account.subdomain) %></td></tr>
        <% end %>
        
      <% end %>
      </tbody>
    </table>
  </div>

  <!-- calendar -->
  <div style="width: 634px; float: left; overflow: auto;">
    <table id="leave">
    
      <thead>
      <!-- months -->
        <tr>
          <% @staff_calendar.date_range.inject({}) { |r, d| r[d.strftime('%b %y')] = (r[d.strftime('%b %y')] || 0) + 1; r }.each do |month, count| %>
            <td colspan="<%= count %>"><%= month %></td>
          <% end %>
        </tr>
        <!-- days of week -->
        <tr>
          <% @staff_calendar.date_range.each do |date| %>
            <td>
              <div class="week_days">
              <%= case date.wday
                  when 0 then 'S'
                  when 1 then 'M'
                  when 2 then 'T'
                  when 3 then 'W'
                  when 4 then 'T'
                  when 5 then 'F'
                  when 6 then 'S'
                end %>
              </div>
            </td>
          <% end %>
        </tr>
        <!-- days -->
        <tr>
          <% @staff_calendar.date_range.each do |date| %>
            <td><div class="days"><%= date.day %></div></td>
          <% end %>
        </tr>
      </thead>
        
      <tbody>
      <% @staff_calendar.employees.each do |employee| %>
        <tr>
          <td colspan="<%= @staff_calendar.date_range.count %>"></td>
        </tr>
        <% @staff_calendar.leave_requests_for(employee).each do |leave_request| %>
          <tr>
            <% (@staff_calendar.date_from..leave_request.date_from).each do |date| %>
              <td></td>
            <% end %>
          
            <td colspan="<%= (leave_request.date_from..leave_request.date_to).count %>" 
                class="leave_request_#{leave_request.status_text.underscore}"
                style="background-color: <%= leave_request.leave_type.hex_color %>;">
            </td>

            <% (leave_request.date_to..@staff_calendar.date_to).each do |date| %>
              <td></td>
            <% end %>

          </tr>
        <% end %>
      
      <% end %>
      </tbody>
      
    </table>
  </div>

</div>

<p style="text-align: right;"><%= link_to 'Download CSV', '/TODO' %></p>

<script type="text/javascript">
  $("#slider").slider({
			min: 0,
			max: 10,
			step: 1,
			slide: function(event, ui) {
				
				$(".week_days").css('display', (ui.value > 4 ? 'inline' : 'none'));
				$(".days").css('display', (ui.value > 6 ? 'inline' : 'none'));
				
				switch(ui.value) {
				  case 0:
				    $("#leave td").css('min-width', '2px');
				    $("#leave td").css('border-left', 'none');
				    $("#leave td:nth-child(even)").css('background-color', '');
				    break;
				  case 1:
				    $("#leave td").css('min-width', '8px');
				    $("#leave td").css('border-left', 'none');
				    $("#leave td:nth-child(even)").css('background-color', '');
				    break;
				  case 2:
				    $("#leave td").css('min-width', '10px');
				    $("#leave td").css('border-left', 'none');
				    $("#leave td:nth-child(even)").css('background-color', '');
				    break;
				  case 3:
				    $("#leave td").css('min-width', '12px');
				    $("#leave td").css('border-left', 'none');
				    $("#leave td:nth-child(even)").css('background-color', '#F0F0F0');
				    break;
				  case 4:
				    $("#leave td").css('min-width', '14px');
				    $("#leave td").css('border-left', '1px solid #C0C0C0');
				    $("#leave td:nth-child(even)").css('background-color', '#F0F0F0');
				    break;
				  case 5:
				    $("#leave td").css('min-width', '18px');
				    $("#leave td").css('border-left', '1px solid #C0C0C0');
				    $("#leave td:nth-child(even)").css('background-color', '#F0F0F0');
				    break;
				  case 6:
				    $("#leave td").css('min-width', '22px');
				    $("#leave td").css('border-left', '1px solid #C0C0C0');
				    $("#leave td:nth-child(even)").css('background-color', '#F0F0F0');
				    break;
				  case 7:
				    $("#leave td").css('min-width', '28px');
				    $("#leave td").css('border-left', '1px solid #C0C0C0');
				    $("#leave td:nth-child(even)").css('background-color', '#F0F0F0');
				    break;
				  case 8:
				    $("#leave td").css('min-width', '32px');
				    $("#leave td").css('border-left', '1px solid #C0C0C0');
				    $("#leave td:nth-child(even)").css('background-color', '#F0F0F0');
				    break;
				  case 9:
				    $("#leave td").css('min-width', '38px');
				    $("#leave td").css('border-left', '1px solid #C0C0C0');
				    $("#leave td:nth-child(even)").css('background-color', '#F0F0F0');
				    break;
				  case 10:
				    $("#leave td").css('min-width', '45px');
				    $("#leave td").css('border-left', '1px solid #C0C0C0');
				    $("#leave td:nth-child(even)").css('background-color', '#F0F0F0');
				    break;
				}
				
			}
		});
</script>


