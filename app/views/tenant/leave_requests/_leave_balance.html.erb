<% if employee.nil? || leave_type.nil? || date_from.nil? || (!date_to.nil? && date_from > date_to)  %>

  <% if employee.nil? %>
    <p>Please supply an <em>employee</em>, <em>leave type</em>, <em>from</em> and <em>to</em> dates.</p>
  <% else %>
    <p>Please supply a <em>leave type</em>, <em>from</em> and <em>to</em> dates.</p>
  <% end %>

<% else

    leave_allowance = leave_type.allowance_for(employee, date_from)
    leave_take_on = leave_type.leave_take_on_for(employee, date_from)
    leave_taken_to_date = leave_type.leave_taken_for(employee, date_from)
    leave_balance = leave_allowance - leave_take_on - leave_taken_to_date
  
%>

  <p>As at <strong><%= date_from.strftime("%e %b %Y") %></strong></p>

  <div class="field">
    <div><%= label_tag :leave_allowance %></div>
    <span><%= text_field_tag :leave_allowance, leave_allowance, { :style => 'width: 158px;', :disabled => true} %></span>
    <span class="field_info">days</span>
  </div>
  
  <% if leave_take_on > 0 %>
    <div class="field">
      <div><em>less</em> <%= label_tag :take_on_balance %></div>
      <span><%= text_field_tag :take_on_balance, leave_take_on, { :style => 'width: 158px;', :disabled => true} %></span>
      <span class="field_info">days</span>
    </div>
  <% end %>

  <div class="field">
    <div><em>less</em> <%= label_tag :leave_taken %></div>
    <span><%= text_field_tag :leave_taken, leave_taken_to_date, { :style => 'width: 158px;', :disabled => true} %></span>
    <span class="field_info">days</span>
  </div>

  <div class="field">
    <div class="total_row"><%= label_tag :leave_balance %></div>
    <span><%= text_field_tag :leave_balance, leave_balance, { :style => 'width: 158px;', :disabled => true} %></span>
    <span class="field_info">days</span>
  </div>

  <% unless date_to.nil? 

    # create dummy request (which isn't saved) to calculate the duration
    request_duration = current_account.leave_requests.build(
      :employee_id => employee.id,
      :leave_type_id => leave_type.id,
      :date_from => date_from,
      :half_day_from => half_day_from,
      :date_to => date_to,
      :half_day_to => half_day_to
    ).calculate_duration

  %>
  
    <p></p>

    <div class="field">
      <div><em>less</em> <%= label_tag :leave_requested %></div>
      <span><%= text_field_tag :leave_requested, request_duration, { :style => 'width: 158px;', :disabled => true} %></span>
      <span class="field_info">days</span>
    </div>

    <div class="field">
      <div class="total_row"><%= label_tag :new_balance %></div>
      <span><%= text_field_tag :new_balance, leave_balance - (unpaid ? 0 : request_duration), { :style => 'width: 158px;', :disabled => true} %></span>
      <span class="field_info">days</span>
    </div>

  <% end %>

  <p class="detailed_leave_balance_link"><%= link_to 'Detailed Balance', balance_path(:employee => employee.to_param), :target => '_blank' %></p>

<% end %>
