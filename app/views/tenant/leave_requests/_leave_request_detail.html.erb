<div class="leave_request box_radius">
  <h3>Leave Request Details</h3>
  <table>

    <tr>
      <td width="140px">Created:</td>
      <td><%= leave_request.created_at_s %></td>
      <td width="160px"></td>
    </tr>
    
    <% if leave_request.captured? %>

      <tr>
        <td>Captured By:</td>
        <td><%= leave_request.captured_by %></td>
        <td></td>
      </tr>
      
      <tr>
        <td colspan="3"><br /></td>
      </tr>
      
    <% end %>

    <tr>
      <td>Type:</td>
      <td><%= leave_request.leave_type %> Leave</td>
      <td></td>
    </tr>
    
    <% if leave_request.unpaid %>
      <tr>
        <td>Unpaid:</td>
        <td>Yes</td>
        <td></td>
      </tr>
    <% end %>

    <tr>
      <td>From:</td>
      <td><%= leave_request.date_from_s %></td>
      <td></td>
    </tr>

    <tr>
      <td>To:</td>
      <td><%= leave_request.date_to_s %></td>
      <td></td>
    </tr>

    <tr>
      <td><abbr title="Excludes weekends and public holidays">Duration</abbr>:</td>
      <td><%= pluralize(leave_request.duration, 'day') %></td>
      <td></td>
    </tr>
    
    <% if leave_request.document_attached? %>
    <tr>
      <td>Document:</td>
      <td><%= link_to leave_request.document_file_name, leave_request.document.url %></td>
      <td></td>
    </tr>
    <% end %>
    
    <% if leave_request.comment.present? %>
    <tr>
      <td style="vertical-align: top;">Comment:</td>
      <td colspan="2">
        <div style="overflow: auto;">
          <%= leave_request.comment %>
        </div>
      </td>
    </tr>
    <% end %>

    <tr>
      <td>Assigned Approver:</td>
      <td><%= leave_request.approver %></td>
    </tr>

  </table>

</div>

<% unless leave_request.status_new? %>
  <div class="leave_request box_radius">
    <h3>Leave Status</h3>
    <table>

      <tr>
        <td width="140px">Status:</td>
        <td width="160px"><%= leave_request.status_text %></td>
        <td></td>
      </tr>
      
      <%= render :partial => "leave_request_detail_#{leave_request.status_text.downcase}", :locals => { :leave_request => leave_request } %>

    </table>
  </div>
<% end %>

<% if leave_request.status_new? || leave_request.status_active? %>

  <%
    leave_type = leave_request.leave_type
    employee = leave_request.employee
    date_from = leave_request.date_from

    leave_take_on = leave_type.leave_take_on_for(employee, date_from)
    leave_allowance = leave_type.allowance_for(employee, date_from)

    leave_taken = leave_type.leave_taken_for(employee, date_from)
    leave_outstanding = leave_type.leave_outstanding_for(employee, date_from) # NB: includes this request

    # calculate available leave balance
    leave_available = leave_take_on + leave_allowance - leave_taken - leave_outstanding
   %>
 
  <div class="leave_request box_radius">
    <h3>Leave Balance Details</h3>
    <table>

      <tr>
        <td width="140px">Balance as at:</td>
        <td width="160px"><%= leave_request.date_from_s %></td>
        <td></td>
      </tr>

      <% if leave_take_on > 0 %>
        <tr>
          <td>Take On:</td>
          <td><%= pluralize(number_with_precision(leave_take_on, :precision => 1), 'day') %></td>
          <td></td>
        </tr>
      <% end %>

      <tr>
        <td>Allowance:</td>
        <td><%= pluralize(number_with_precision(leave_allowance, :precision => 1), 'day') %></td>
        <td></td>
      </tr>

      <tr>
        <td>Leave taken:</td>
        <td><%= pluralize(number_with_precision(leave_taken, :precision => 1), 'day') %></td>
        <td></td>
      </tr>

      <% if leave_outstanding > 0 %>
        <tr>
          <td><abbr title="Pending and approved leave not yet taken, including this request">Leave outstanding</abbr>:</td>
          <td><%= pluralize(number_with_precision(leave_outstanding, :precision => 1), 'day') %></td>
          <td></td>
        </tr>
      <% end %>

      <tr>
        <td>Available leave:</td>
        <td><%= pluralize(number_with_precision(leave_available, :precision => 1), 'day') %></td>
        <td></td>
      </tr>
      
    </table>

  </div>

<% end %>

